<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
      <ion-button fill="clear" (click)="selectZMGroup()" title="Camera Groups" 
                  *ngIf="zmGroups.length > 0">
        <ion-icon name="folder"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="toggleHideUnhide()" title="Show/Hide Monitors">
        <ion-icon name="eye"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="showSubMenu = !showSubMenu" title="Toggle Controls">
        <ion-icon name="chevron-down"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-title>{{ currentProfileName }}</ion-title>
    
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="toggleDragMode()" title="Drag Mode" 
                  [color]="isDragMode ? 'primary' : 'medium'">
        <ion-icon name="move"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="resetSizesWithInput()" title="Grid Size">
        <ion-icon name="grid"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="toggleMinimal()" title="Fullscreen">
        <ion-icon name="resize"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Advanced Controls Submenu -->
  <ion-toolbar *ngIf="showSubMenu && !isMinimal">
    <div class="montage-controls">
      <ion-button size="small" fill="outline" (click)="increaseSize()" title="Increase Size">
        <ion-icon name="add"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="decreaseSize()" title="Decrease Size">
        <ion-icon name="remove"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="squeezeMonitors()" title="Reflow">
        <ion-icon name="resize"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="toggleCycling()" 
                  [color]="isCycling() ? 'primary' : 'medium'" title="Cycle Profiles">
        <ion-icon name="bicycle"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="switchMontageProfile()" title="Switch Profile">
        <ion-icon name="settings"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="saveMontageProfile()" title="Save Profile">
        <ion-icon name="save"></ion-icon>
      </ion-button>
      <ion-button size="small" fill="outline" (click)="deleteMontageProfile()" title="Delete Profile">
        <ion-icon name="trash"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [class.minimal]="isMinimal">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Arranging monitors...</p>
  </div>

  <!-- CSS Grid Container for Clean Layout with Virtual Scrolling -->
  <div class="montage-grid" [style.display]="isLoading ? 'none' : 'grid'" *ngIf="!isDragMode">
    <div *ngFor="let monitor of monitors; trackBy: trackByMonitorId" class="monitor-card" 
         [style.display]="monitor.listDisplay === 'show' ? 'block' : 'none'"
         [class.placeholder-slot]="monitor.hasPlaceholder"
         (dblclick)="maximizeCamera(monitor.Monitor.Id)">
      <div class="monitor-stream-container" [class.alarmed]="monitor.isAlarmed">
        <img class="monitor-stream-image" 
             [src]="getMonitorImageUrl(monitor)" 
             [alt]="monitor.Monitor.Name"
             (error)="onImageError($event)">
        
        <div class="monitor-overlay">
          <div class="monitor-status" [style.background-color]="getMonitorStatusColor(monitor)">
            <ion-icon name="videocam"></ion-icon>
          </div>
          <div class="event-overlay" *ngIf="monitor.lastEvent">
            <ion-icon name="notifications" class="event-icon"></ion-icon>
            <span class="event-count">{{monitor.eventCount}}</span>
          </div>
          <div class="stamp-indicator" *ngIf="monitor.isStamp">
            <ion-icon name="pin"></ion-icon>
          </div>
        </div>
        
        <div class="monitor-timestamp">
          {{getCurrentTime()}}
        </div>
        
        <div class="version-badge" *ngIf="monitor.version">
          {{monitor.version}}
        </div>
      </div>
      
      <div class="monitor-info">
        <h4>{{monitor.Monitor.Name}}</h4>
        <span class="monitor-id">ID: {{monitor.Monitor.Id}}</span>
        <small class="grid-position" *ngIf="monitor.gridPosition">
          ({{monitor.gridPosition.row}}, {{monitor.gridPosition.col}})
        </small>
        <div class="event-info" *ngIf="monitor.lastEvent">
          <small>Latest: {{monitor.lastEvent.Event?.StartTime || 'Unknown'}}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- GridStack Container for Drag Mode -->
  <div #gridContainer class="grid-stack" [style.display]="isLoading ? 'none' : (isDragMode ? 'block' : 'none')"></div>

  <!-- Streaming Mode Controls -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isMinimal">
    <ion-fab-button size="small">
      <ion-icon name="videocam"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button (click)="switchToSnapshots()" title="Snapshots">
        <ion-icon name="camera"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="switchToLiveStreaming()" title="Live Streaming">
        <ion-icon name="videocam"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="loadMonitors(true)" title="Refresh">
        <ion-icon name="refresh"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

  <!-- Minimal Mode Controls -->
  <ion-fab vertical="bottom" horizontal="start" slot="fixed" *ngIf="isMinimal">
    <ion-fab-button size="small">
      <ion-icon name="chevron-up"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button (click)="increaseSize()" title="Increase Size">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="decreaseSize()" title="Decrease Size">
        <ion-icon name="remove"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="squeezeMonitors()" title="Reflow">
        <ion-icon name="resize"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="toggleMinimal()" title="Exit Fullscreen">
        <ion-icon name="close"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

  <div *ngIf="!isLoading && monitors.length === 0" class="empty-state">
    <p>No active monitors found</p>
    <ion-button (click)="loadMonitors(true)">Retry</ion-button>
  </div>
</ion-content>

<style>
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 50vh;
}

.montage-grid {
  padding: 8px;
}

.monitor-card {
  margin: 4px;
  border-radius: 8px;
}

.monitor-stream-container {
  position: relative;
  width: 100%;
  height: 200px;
  overflow: hidden;
}

.monitor-stream-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.monitor-overlay {
  position: absolute;
  top: 8px;
  right: 8px;
}

.monitor-status {
  background: rgba(0, 0, 0, 0.7);
  border-radius: 50%;
  padding: 8px;
  color: white;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 50vh;
  text-align: center;
}
</style>
